name: CI/CD — Build, Test Containers, Push

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  REGISTRY: docker.io
  DOCKERHUB_USERNAME: ${{ vars.ST_DOCKERHUB_USERNAME }}
  SHORT_SHA: ${{ github.sha || '' }}

jobs:
  build-test-push:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set SHORT_SHA (7 chars)
        id: vars
        run: echo "SHORT_SHA=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Preflight – validate creds/vars
        run: |
          test -n "${{ vars.ST_DOCKERHUB_USERNAME }}" || (echo "❌ ST_DOCKERHUB_USERNAME empty" && exit 1)
          test -n "${{ secrets.ST_DOCKERHUB_TOKEN }}"   || (echo "❌ ST_DOCKERHUB_TOKEN empty" && exit 1)
          docker --version

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # -------- Build images (load into local daemon for testing) --------
      - name: Build backend (local load)
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          load: true                     # load into local Docker engine
          tags: bnpl-backend:ci

      - name: Build frontend (local load)
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          load: true
          tags: bnpl-frontend:ci

      # -------- Container smoke tests on a private network --------
      - name: Create test network
        run: docker network create ci-net

      - name: Run backend container
        run: |
          docker run -d --rm \
            --name backend \
            --network ci-net \
            -p 4000:4000 \
            bnpl-backend:ci
          # wait briefly for boot
          for i in {1..20}; do curl -fsS http://localhost:4000/health && break || sleep 1; done
          curl -fsS http://localhost:4000/health
          curl -fsS http://localhost:4000/api/products

      - name: Run frontend container (talks to backend via service name)
        run: |
          docker run -d --rm \
            --name frontend \
            --network ci-net \
            -e NEXT_PUBLIC_API_BASE_URL=http://backend:4000 \
            -p 3000:3000 \
            bnpl-frontend:ci
          # wait for Next.js to boot
          for i in {1..30}; do curl -fsS http://localhost:3000 && break || sleep 1; done
          curl -fsS http://localhost:3000

      - name: Stop containers & network
        if: always()
        run: |
          docker ps -a
          docker stop frontend || true
          docker stop backend || true
          docker network rm ci-net || true

      # -------- Login & push only if all tests passed --------
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.ST_DOCKERHUB_USERNAME }}
          password: ${{ secrets.ST_DOCKERHUB_TOKEN }}

      - name: Tag images for Docker Hub
        run: |
          B=${{ vars.ST_DOCKERHUB_USERNAME }}/bnpl-backend
          F=${{ vars.ST_DOCKERHUB_USERNAME }}/bnpl-frontend
          SHA=${{ steps.vars.outputs.SHORT_SHA }}
          docker tag bnpl-backend:ci  $B:latest
          docker tag bnpl-backend:ci  $B:$SHA
          docker tag bnpl-frontend:ci $F:latest
          docker tag bnpl-frontend:ci $F:$SHA
          docker images | grep -E "bnpl-(back|front)end|${{ vars.ST_DOCKERHUB_USERNAME }}"

      - name: Push images to Docker Hub
        run: |
          B=${{ vars.ST_DOCKERHUB_USERNAME }}/bnpl-backend
          F=${{ vars.ST_DOCKERHUB_USERNAME }}/bnpl-frontend
          SHA=${{ steps.vars.outputs.SHORT_SHA }}
          docker push $B:latest
          docker push $B:$SHA
          docker push $F:latest
          docker push $F:$SHA
